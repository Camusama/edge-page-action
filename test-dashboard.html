<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edge Sync State å®Œæ•´æµ‹è¯•ä»ªè¡¨æ¿</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }
      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }
      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }
      .dashboard {
        max-width: 1400px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
      }
      .card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      .card-title {
        color: #333;
        border-bottom: 3px solid #2196f3;
        padding-bottom: 10px;
        margin-bottom: 20px;
        font-size: 1.3em;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #f44336;
        animation: pulse 2s infinite;
      }
      .status-indicator.connected {
        background: #4caf50;
      }
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin: 15px 0;
      }
      .stat-item {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        border: 1px solid #90caf9;
      }
      .stat-value {
        font-size: 1.5em;
        font-weight: bold;
        color: #1976d2;
      }
      .stat-label {
        font-size: 0.85em;
        color: #666;
        margin-top: 5px;
      }
      .btn {
        background: linear-gradient(135deg, #2196f3, #1976d2);
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        margin: 4px;
        font-weight: 500;
        transition: all 0.3s ease;
        font-size: 14px;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
      }
      .btn.success {
        background: linear-gradient(135deg, #4caf50, #45a049);
      }
      .btn.danger {
        background: linear-gradient(135deg, #f44336, #d32f2f);
      }
      .btn.warning {
        background: linear-gradient(135deg, #ff9800, #f57c00);
      }
      .btn.small {
        padding: 6px 12px;
        font-size: 12px;
      }
      .input-group {
        margin: 10px 0;
      }
      .input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }
      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #2196f3;
        box-shadow: 0 0 10px rgba(33, 150, 243, 0.2);
      }
      .log-container {
        background: #1a1a1a;
        border-radius: 8px;
        padding: 15px;
        height: 300px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.4;
        border: 2px solid #333;
      }
      .log-entry {
        margin-bottom: 5px;
        padding: 2px 0;
      }
      .log-entry.info {
        color: #00ff00;
      }
      .log-entry.success {
        color: #4caf50;
      }
      .log-entry.error {
        color: #f44336;
      }
      .log-entry.warning {
        color: #ff9800;
      }
      .json-display {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 12px;
        margin: 10px 0;
        font-family: 'Courier New', monospace;
        font-size: 11px;
        max-height: 150px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
      .button-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 15px 0;
      }
      .full-width {
        grid-column: 1 / -1;
      }
      .response-display {
        margin-top: 10px;
        padding: 10px;
        background: #f0f8ff;
        border-radius: 6px;
        border-left: 4px solid #2196f3;
        font-size: 13px;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>ğŸš€ Edge Sync State æµ‹è¯•ä»ªè¡¨æ¿</h1>
      <p>å®Œæ•´åŠŸèƒ½æµ‹è¯• - å®æ—¶çŠ¶æ€åŒæ­¥ä¸å‰ç«¯æ“ä½œæ¨é€</p>
    </div>

    <div class="dashboard">
      <!-- è¿æ¥çŠ¶æ€å¡ç‰‡ -->
      <div class="card">
        <h3 class="card-title">
          ğŸ”— è¿æ¥çŠ¶æ€
          <div class="status-indicator" id="statusIndicator"></div>
        </h3>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="connectionStatus">ç¦»çº¿</div>
            <div class="stat-label">è¿æ¥çŠ¶æ€</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="connectionTime">0s</div>
            <div class="stat-label">è¿æ¥æ—¶é•¿</div>
          </div>
        </div>
        <div class="input-group">
          <label>ChatBot ID:</label>
          <input type="text" id="chatbotIdDisplay" readonly />
        </div>
        <div class="button-row">
          <button class="btn success" onclick="connect()">ğŸ”Œ è¿æ¥</button>
          <button class="btn danger" onclick="disconnect()">âŒ æ–­å¼€</button>
          <button class="btn warning" onclick="testConnection()">ğŸ§ª æµ‹è¯•</button>
        </div>
      </div>

      <!-- ç³»ç»Ÿç›‘æ§å¡ç‰‡ -->
      <div class="card">
        <h3 class="card-title">ğŸ“Š ç³»ç»Ÿç›‘æ§</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="serverHealth">-</div>
            <div class="stat-label">æœåŠ¡å™¨çŠ¶æ€</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="totalConnections">0</div>
            <div class="stat-label">æ€»è¿æ¥æ•°</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="serverUptime">-</div>
            <div class="stat-label">è¿è¡Œæ—¶é—´</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="memoryUsage">-</div>
            <div class="stat-label">å†…å­˜ä½¿ç”¨</div>
          </div>
        </div>
        <div class="button-row">
          <button class="btn" onclick="getHealthCheck()">â¤ï¸ å¥åº·æ£€æŸ¥</button>
          <button class="btn" onclick="getSystemStatus()">ğŸ“ˆ ç³»ç»ŸçŠ¶æ€</button>
          <button class="btn" onclick="getConnections()">ğŸ‘¥ è¿æ¥åˆ—è¡¨</button>
        </div>
        <div id="systemResponse" class="response-display"></div>
      </div>

      <!-- ChatBot è¿æ¥ç®¡ç†å¡ç‰‡ -->
      <div class="card">
        <h3 class="card-title">ğŸ¤– ChatBot è¿æ¥ç®¡ç†</h3>
        <div class="input-group">
          <label>é€‰æ‹©ç›®æ ‡ ChatBot:</label>
          <select id="targetChatbotSelect">
            <option value="">-- é€‰æ‹© ChatBot --</option>
          </select>
          <button class="btn small" onclick="refreshChatbotList()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
        </div>
        <div class="input-group">
          <label>æˆ–æ‰‹åŠ¨è¾“å…¥ ChatBot ID:</label>
          <input type="text" id="manualChatbotId" placeholder="è¾“å…¥ ChatBot ID" />
          <button class="btn small" onclick="useManualChatbotId()">âœ… ä½¿ç”¨</button>
        </div>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="selectedChatbotId">æœªé€‰æ‹©</div>
            <div class="stat-label">å½“å‰ç›®æ ‡</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="targetConnectionStatus">-</div>
            <div class="stat-label">è¿æ¥çŠ¶æ€</div>
          </div>
        </div>
        <div class="button-row">
          <button class="btn warning" onclick="disconnectTarget()">âŒ æ–­å¼€ç›®æ ‡</button>
          <button class="btn" onclick="getTargetState()">ğŸ“„ è·å–çŠ¶æ€</button>
          <button class="btn success" onclick="sendTestAction()">âš¡ å‘é€æµ‹è¯•</button>
        </div>
        <div id="chatbotResponse" class="response-display"></div>
      </div>

      <!-- é¡µé¢çŠ¶æ€ç®¡ç†å¡ç‰‡ -->
      <div class="card">
        <h3 class="card-title">ğŸ“„ é¡µé¢çŠ¶æ€ç®¡ç†</h3>
        <div class="input-group">
          <label>ç›®æ ‡ ChatBot:</label>
          <select id="pageStateChatbotSelect">
            <option value="">-- ä½¿ç”¨å½“å‰ä»ªè¡¨æ¿ --</option>
          </select>
          <button class="btn small" onclick="syncPageStateChatbots()">ğŸ”„ åŒæ­¥ç›®æ ‡</button>
        </div>
        <div class="input-group">
          <label>é¡µé¢URL:</label>
          <input type="text" id="pageUrl" value="https://example.com/test" />
        </div>
        <div class="input-group">
          <label>é¡µé¢æ ‡é¢˜:</label>
          <input type="text" id="pageTitle" value="æµ‹è¯•é¡µé¢" />
        </div>
        <div class="input-group">
          <label>è‡ªå®šä¹‰æ•°æ® (JSON):</label>
          <textarea id="customData" rows="3">
{"user": "å¼ ä¸‰", "role": "admin", "timestamp": "2024-01-01", "features": ["sync", "actions"]}</textarea
          >
        </div>
        <div class="button-row">
          <button class="btn success" onclick="updatePageState()">ğŸ’¾ æ›´æ–°çŠ¶æ€</button>
          <button class="btn" onclick="getPageState()">ğŸ“– è·å–çŠ¶æ€</button>
          <button class="btn danger" onclick="deletePageState()">ğŸ—‘ï¸ åˆ é™¤çŠ¶æ€</button>
          <button class="btn warning" onclick="loadTargetPageState()">ğŸ“¥ åŠ è½½ç›®æ ‡çŠ¶æ€</button>
        </div>
        <div id="pageStateResponse" class="response-display"></div>
      </div>

      <!-- Action æ¨é€æµ‹è¯•å¡ç‰‡ -->
      <div class="card">
        <h3 class="card-title">âš¡ Action æ¨é€æµ‹è¯•</h3>
        <div class="input-group">
          <label>ç›®æ ‡ ChatBot:</label>
          <select id="actionChatbotSelect">
            <option value="">-- ä½¿ç”¨é€‰ä¸­çš„ç›®æ ‡ --</option>
          </select>
          <button class="btn small" onclick="syncActionChatbots()">ğŸ”„ åŒæ­¥ç›®æ ‡</button>
        </div>
        <div class="input-group">
          <label>Action ç±»å‹:</label>
          <select id="actionType">
            <option value="navigate">ğŸ§­ å¯¼èˆª (Navigate)</option>
            <option value="click">ğŸ‘† ç‚¹å‡» (Click)</option>
            <option value="input">âŒ¨ï¸ è¾“å…¥ (Input)</option>
            <option value="scroll">ğŸ“œ æ»šåŠ¨ (Scroll)</option>
            <option value="custom">ğŸ”§ è‡ªå®šä¹‰ (Custom)</option>
          </select>
        </div>
        <div class="input-group">
          <label>ç›®æ ‡å…ƒç´  (CSSé€‰æ‹©å™¨):</label>
          <input type="text" id="actionTarget" value="#submit-button" />
        </div>
        <div class="input-group">
          <label>Action æ•°æ® (JSON):</label>
          <textarea id="actionPayload" rows="2">
{"url": "https://www.google.com", "value": "æµ‹è¯•æ•°æ®"}</textarea
          >
        </div>
        <div class="button-row">
          <button class="btn success" onclick="sendCustomAction()">ğŸš€ å‘é€ Action</button>
          <button class="btn warning" onclick="sendQuickActions()">âš¡ å¿«é€Ÿæµ‹è¯•</button>
          <button class="btn" onclick="broadcastAction()">ğŸ“¢ å¹¿æ’­</button>
        </div>
        <div id="actionResponse" class="response-display"></div>
      </div>

      <!-- ç®¡ç†åŠŸèƒ½å¡ç‰‡ -->
      <div class="card">
        <h3 class="card-title">ğŸ› ï¸ ç®¡ç†åŠŸèƒ½</h3>
        <div class="input-group">
          <label>å¹¿æ’­æ¶ˆæ¯:</label>
          <input
            type="text"
            id="broadcastMessage"
            value="ç³»ç»Ÿé€šçŸ¥ï¼šæµ‹è¯•æ¶ˆæ¯"
            placeholder="è¾“å…¥è¦å¹¿æ’­çš„æ¶ˆæ¯"
          />
        </div>
        <div class="button-row">
          <button class="btn" onclick="adminBroadcast()">ğŸ“¢ ç®¡ç†å¹¿æ’­</button>
          <button class="btn warning" onclick="adminCleanup()">ğŸ§¹ æ¸…ç†è¿æ¥</button>
          <button class="btn danger" onclick="disconnectOthers()">âŒ æ–­å¼€å…¶ä»–</button>
        </div>
        <div class="button-row">
          <button class="btn small" onclick="generateNewChatbotId()">ğŸ”„ æ–°å»ºID</button>
          <button class="btn small" onclick="exportLogs()">ğŸ“¥ å¯¼å‡ºæ—¥å¿—</button>
          <button class="btn small" onclick="importTestData()">ğŸ“¤ å¯¼å…¥æµ‹è¯•</button>
        </div>
        <div id="adminResponse" class="response-display"></div>
      </div>

      <!-- å®æ—¶æ—¥å¿—å¡ç‰‡ -->
      <div class="card full-width">
        <h3 class="card-title">ğŸ“ å®æ—¶æ—¥å¿—</h3>
        <div class="button-row">
          <button class="btn small" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
          <button class="btn small" onclick="toggleAutoScroll()">ğŸ“œ è‡ªåŠ¨æ»šåŠ¨</button>
          <button class="btn small" onclick="filterLogs('all')">å…¨éƒ¨</button>
          <button class="btn small success" onclick="filterLogs('success')">æˆåŠŸ</button>
          <button class="btn small danger" onclick="filterLogs('error')">é”™è¯¯</button>
          <button class="btn small warning" onclick="filterLogs('warning')">è­¦å‘Š</button>
        </div>
        <div id="logContainer" class="log-container"></div>
      </div>
    </div>

    <script>
      // å…¨å±€å˜é‡
      const SERVER_URL = 'http://localhost:3050'
      let CHATBOT_ID = 'dashboard_' + Date.now()
      let eventSource = null
      let connectionStartTime = null
      let connectionTimer = null
      let autoScroll = true
      let logFilter = 'all'
      let selectedTargetChatbotId = '' // é€‰ä¸­çš„ç›®æ ‡ ChatBot ID
      let availableChatbots = [] // å¯ç”¨çš„ ChatBot åˆ—è¡¨

      // åˆå§‹åŒ–
      document.getElementById('chatbotIdDisplay').value = CHATBOT_ID

      // æ—¥å¿—åŠŸèƒ½
      function log(message, type = 'info') {
        const container = document.getElementById('logContainer')
        const timestamp = new Date().toLocaleTimeString()
        const entry = document.createElement('div')
        entry.className = `log-entry ${type}`
        entry.innerHTML = `<span style="color: #888;">[${timestamp}]</span> ${message}`

        if (logFilter === 'all' || logFilter === type) {
          entry.style.display = 'block'
        } else {
          entry.style.display = 'none'
        }

        container.appendChild(entry)

        if (autoScroll) {
          container.scrollTop = container.scrollHeight
        }
      }

      function clearLog() {
        document.getElementById('logContainer').innerHTML = ''
      }

      function toggleAutoScroll() {
        autoScroll = !autoScroll
        log(`è‡ªåŠ¨æ»šåŠ¨å·²${autoScroll ? 'å¼€å¯' : 'å…³é—­'}`, 'info')
      }

      function filterLogs(type) {
        logFilter = type
        const entries = document.querySelectorAll('.log-entry')
        entries.forEach(entry => {
          if (type === 'all' || entry.classList.contains(type)) {
            entry.style.display = 'block'
          } else {
            entry.style.display = 'none'
          }
        })
      }

      // è¿æ¥ç®¡ç†
      function updateConnectionStatus(connected) {
        const indicator = document.getElementById('statusIndicator')
        const status = document.getElementById('connectionStatus')

        if (connected) {
          indicator.classList.add('connected')
          status.textContent = 'åœ¨çº¿'
          connectionStartTime = Date.now()
          startConnectionTimer()
        } else {
          indicator.classList.remove('connected')
          status.textContent = 'ç¦»çº¿'
          stopConnectionTimer()
          document.getElementById('connectionTime').textContent = '0s'
        }
      }

      function startConnectionTimer() {
        connectionTimer = setInterval(() => {
          if (connectionStartTime) {
            const elapsed = Math.floor((Date.now() - connectionStartTime) / 1000)
            document.getElementById('connectionTime').textContent = formatTime(elapsed)
          }
        }, 1000)
      }

      function stopConnectionTimer() {
        if (connectionTimer) {
          clearInterval(connectionTimer)
          connectionTimer = null
        }
      }

      function formatTime(seconds) {
        const hours = Math.floor(seconds / 3600)
        const minutes = Math.floor((seconds % 3600) / 60)
        const secs = seconds % 60

        if (hours > 0) {
          return `${hours}h ${minutes}m ${secs}s`
        } else if (minutes > 0) {
          return `${minutes}m ${secs}s`
        } else {
          return `${secs}s`
        }
      }

      // SSE è¿æ¥
      function connect() {
        if (eventSource) {
          eventSource.close()
        }

        log(`æ­£åœ¨è¿æ¥åˆ°æœåŠ¡å™¨... (${CHATBOT_ID})`, 'info')
        eventSource = new EventSource(`${SERVER_URL}/sse/connect/${CHATBOT_ID}`)

        eventSource.onopen = function () {
          updateConnectionStatus(true)
          log('âœ… SSE è¿æ¥å·²å»ºç«‹', 'success')
        }

        eventSource.onmessage = function (event) {
          try {
            const data = JSON.parse(event.data)
            log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${data.type}`, 'info')

            if (data.type === 'action') {
              handleAction(data.data)
            } else if (data.type === 'ping') {
              // å¿ƒè·³æ¶ˆæ¯ï¼Œä¸æ˜¾ç¤ºè¯¦ç»†å†…å®¹
            } else {
              log(`ğŸ“„ æ¶ˆæ¯å†…å®¹: ${JSON.stringify(data, null, 2)}`, 'info')
            }
          } catch (error) {
            log(`âŒ è§£ææ¶ˆæ¯å¤±è´¥: ${error.message}`, 'error')
          }
        }

        eventSource.onerror = function (error) {
          updateConnectionStatus(false)
          log('âŒ SSE è¿æ¥é”™è¯¯', 'error')
        }
      }

      function disconnect() {
        if (eventSource) {
          eventSource.close()
          eventSource = null
        }
        updateConnectionStatus(false)
        log('ğŸ”Œ SSE è¿æ¥å·²æ–­å¼€', 'warning')
      }

      function testConnection() {
        log('ğŸ§ª æµ‹è¯•è¿æ¥...', 'info')
        fetch(`${SERVER_URL}/api/health`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              log('âœ… æœåŠ¡å™¨è¿æ¥æ­£å¸¸', 'success')
            } else {
              log('âŒ æœåŠ¡å™¨å“åº”å¼‚å¸¸', 'error')
            }
          })
          .catch(error => {
            log(`âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
          })
      }

      // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
      window.onload = function () {
        log('ğŸš€ æµ‹è¯•ä»ªè¡¨æ¿å·²åŠ è½½', 'success')
        log(`ğŸ†” ChatBot ID: ${CHATBOT_ID}`, 'info')

        // è‡ªåŠ¨è¿›è¡Œå¥åº·æ£€æŸ¥
        setTimeout(() => {
          getHealthCheck()
        }, 1000)
      }

      // é¡µé¢å¸è½½æ—¶æ–­å¼€è¿æ¥
      window.onbeforeunload = function () {
        disconnect()
      }

      // Action å¤„ç†
      function handleAction(action) {
        log(`âš¡ å¤„ç† Action: ${action.type}`, 'warning')

        switch (action.type) {
          case 'navigate':
            log(`ğŸ§­ æ¨¡æ‹Ÿå¯¼èˆªåˆ°: ${action.payload?.url || 'unknown'}`, 'info')
            break
          case 'click':
            log(`ğŸ‘† æ¨¡æ‹Ÿç‚¹å‡»å…ƒç´ : ${action.target || 'unknown'}`, 'info')
            break
          case 'input':
            log(`âŒ¨ï¸ æ¨¡æ‹Ÿè¾“å…¥: ${action.target} = ${action.payload?.value || 'unknown'}`, 'info')
            break
          case 'scroll':
            log(`ğŸ“œ æ¨¡æ‹Ÿæ»šåŠ¨: ${JSON.stringify(action.payload)}`, 'info')
            break
          default:
            log(`ğŸ”§ è‡ªå®šä¹‰ Action: ${JSON.stringify(action)}`, 'info')
        }
      }

      // API è¯·æ±‚è¾…åŠ©å‡½æ•°
      async function apiRequest(url, options = {}) {
        try {
          const response = await fetch(url, {
            headers: {
              'Content-Type': 'application/json',
              ...options.headers,
            },
            ...options,
          })

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`)
          }

          const data = await response.json()
          return { success: true, data }
        } catch (error) {
          return { success: false, error: error.message }
        }
      }

      // ç³»ç»Ÿç›‘æ§åŠŸèƒ½
      async function getHealthCheck() {
        log('â¤ï¸ æ‰§è¡Œå¥åº·æ£€æŸ¥...', 'info')
        const result = await apiRequest(`${SERVER_URL}/api/health`)

        if (result.success) {
          log('âœ… å¥åº·æ£€æŸ¥é€šè¿‡', 'success')
          document.getElementById('serverHealth').textContent = 'å¥åº·'
          document.getElementById('totalConnections').textContent =
            result.data.data.connections.totalConnections
          showResponse('systemResponse', result.data)
        } else {
          log(`âŒ å¥åº·æ£€æŸ¥å¤±è´¥: ${result.error}`, 'error')
          document.getElementById('serverHealth').textContent = 'å¼‚å¸¸'
        }
      }

      async function getSystemStatus() {
        log('ğŸ“ˆ è·å–ç³»ç»ŸçŠ¶æ€...', 'info')
        const result = await apiRequest(`${SERVER_URL}/admin/status`)

        if (result.success) {
          log('âœ… ç³»ç»ŸçŠ¶æ€è·å–æˆåŠŸ', 'success')
          const data = result.data.data
          document.getElementById('serverUptime').textContent = formatTime(Math.floor(data.uptime))
          document.getElementById('memoryUsage').textContent = formatBytes(data.memory.heapUsed)
          showResponse('systemResponse', result.data)
        } else {
          log(`âŒ è·å–ç³»ç»ŸçŠ¶æ€å¤±è´¥: ${result.error}`, 'error')
        }
      }

      async function getConnections() {
        log('ğŸ‘¥ è·å–è¿æ¥åˆ—è¡¨...', 'info')
        const result = await apiRequest(`${SERVER_URL}/admin/connections`)

        if (result.success) {
          log(`âœ… è¿æ¥åˆ—è¡¨è·å–æˆåŠŸï¼Œå…± ${result.data.data.total} ä¸ªè¿æ¥`, 'success')

          // æ›´æ–°å¯ç”¨çš„ ChatBot åˆ—è¡¨
          availableChatbots = result.data.data.connections || []
          updateChatbotSelect()

          showResponse('systemResponse', result.data)
        } else {
          log(`âŒ è·å–è¿æ¥åˆ—è¡¨å¤±è´¥: ${result.error}`, 'error')
        }
      }

      // ChatBot è¿æ¥ç®¡ç†åŠŸèƒ½
      function updateChatbotSelect() {
        const selects = [
          { id: 'targetChatbotSelect', defaultText: '-- é€‰æ‹© ChatBot --' },
          { id: 'pageStateChatbotSelect', defaultText: '-- ä½¿ç”¨å½“å‰ä»ªè¡¨æ¿ --' },
          { id: 'actionChatbotSelect', defaultText: '-- ä½¿ç”¨é€‰ä¸­çš„ç›®æ ‡ --' },
        ]

        selects.forEach(selectInfo => {
          const select = document.getElementById(selectInfo.id)
          if (!select) return

          // ä¿å­˜å½“å‰é€‰ä¸­å€¼
          const currentValue = select.value

          // æ¸…ç©ºç°æœ‰é€‰é¡¹
          select.innerHTML = `<option value="">${selectInfo.defaultText}</option>`

          // æ·»åŠ å¯ç”¨çš„ ChatBot
          availableChatbots.forEach(chatbot => {
            const option = document.createElement('option')
            option.value = chatbot.chatbotId
            option.textContent = `${chatbot.chatbotId} (${formatTime(Math.floor((Date.now() - chatbot.connectedAt) / 1000))})`
            select.appendChild(option)
          })

          // æ¢å¤é€‰ä¸­çŠ¶æ€
          if (currentValue) {
            select.value = currentValue
          } else if (selectInfo.id === 'targetChatbotSelect' && selectedTargetChatbotId) {
            select.value = selectedTargetChatbotId
          }
        })
      }

      async function refreshChatbotList() {
        log('ğŸ”„ åˆ·æ–° ChatBot åˆ—è¡¨...', 'info')
        await getConnections()
      }

      // åŒæ­¥ç›®æ ‡ ChatBot åˆ°å„ä¸ªåŠŸèƒ½æ¨¡å—
      function syncPageStateChatbots() {
        updateChatbotSelect()
        log('ğŸ”„ é¡µé¢çŠ¶æ€ç®¡ç†ç›®æ ‡å·²åŒæ­¥', 'info')
      }

      function syncActionChatbots() {
        updateChatbotSelect()
        log('ğŸ”„ Action æ¨é€ç›®æ ‡å·²åŒæ­¥', 'info')
      }

      function useManualChatbotId() {
        const manualId = document.getElementById('manualChatbotId').value.trim()
        if (!manualId) {
          log('âŒ è¯·è¾“å…¥ ChatBot ID', 'error')
          return
        }

        selectedTargetChatbotId = manualId
        document.getElementById('selectedChatbotId').textContent = manualId
        document.getElementById('targetConnectionStatus').textContent = 'æ‰‹åŠ¨è¾“å…¥'

        // æ¸…ç©ºé€‰æ‹©æ¡†
        document.getElementById('targetChatbotSelect').value = ''

        log(`âœ… å·²é€‰æ‹©ç›®æ ‡ ChatBot: ${manualId}`, 'success')
      }

      // ç›‘å¬é€‰æ‹©æ¡†å˜åŒ–
      document.addEventListener('DOMContentLoaded', function () {
        const select = document.getElementById('targetChatbotSelect')
        select.addEventListener('change', function () {
          const selectedId = this.value
          if (selectedId) {
            selectedTargetChatbotId = selectedId
            document.getElementById('selectedChatbotId').textContent = selectedId

            // æŸ¥æ‰¾è¿æ¥çŠ¶æ€
            const chatbot = availableChatbots.find(c => c.chatbotId === selectedId)
            if (chatbot) {
              document.getElementById('targetConnectionStatus').textContent = 'åœ¨çº¿'
            } else {
              document.getElementById('targetConnectionStatus').textContent = 'æœªçŸ¥'
            }

            // æ¸…ç©ºæ‰‹åŠ¨è¾“å…¥æ¡†
            document.getElementById('manualChatbotId').value = ''

            log(`âœ… å·²é€‰æ‹©ç›®æ ‡ ChatBot: ${selectedId}`, 'success')
          } else {
            selectedTargetChatbotId = ''
            document.getElementById('selectedChatbotId').textContent = 'æœªé€‰æ‹©'
            document.getElementById('targetConnectionStatus').textContent = '-'
          }
        })
      })

      async function disconnectTarget() {
        if (!selectedTargetChatbotId) {
          log('âŒ è¯·å…ˆé€‰æ‹©ç›®æ ‡ ChatBot', 'error')
          return
        }

        log(`âŒ æ–­å¼€ç›®æ ‡è¿æ¥: ${selectedTargetChatbotId}`, 'info')
        const result = await apiRequest(
          `${SERVER_URL}/admin/connections/${selectedTargetChatbotId}`,
          {
            method: 'DELETE',
          }
        )

        if (result.success) {
          log('âœ… ç›®æ ‡è¿æ¥å·²æ–­å¼€', 'success')
          showResponse('chatbotResponse', result.data)

          // åˆ·æ–°è¿æ¥åˆ—è¡¨
          setTimeout(refreshChatbotList, 1000)
        } else {
          log(`âŒ æ–­å¼€è¿æ¥å¤±è´¥: ${result.error}`, 'error')
        }
      }

      async function getTargetState() {
        if (!selectedTargetChatbotId) {
          log('âŒ è¯·å…ˆé€‰æ‹©ç›®æ ‡ ChatBot', 'error')
          return
        }

        log(`ğŸ“„ è·å–ç›®æ ‡çŠ¶æ€: ${selectedTargetChatbotId}`, 'info')
        const result = await apiRequest(`${SERVER_URL}/api/state/${selectedTargetChatbotId}`)

        if (result.success) {
          if (result.data.data) {
            log('âœ… ç›®æ ‡çŠ¶æ€è·å–æˆåŠŸ', 'success')
            showResponse('chatbotResponse', result.data)
          } else {
            log('â„¹ï¸ ç›®æ ‡æš‚æ— çŠ¶æ€æ•°æ®', 'warning')
          }
        } else {
          log(`âŒ è·å–ç›®æ ‡çŠ¶æ€å¤±è´¥: ${result.error}`, 'error')
        }
      }

      async function sendTestAction() {
        if (!selectedTargetChatbotId) {
          log('âŒ è¯·å…ˆé€‰æ‹©ç›®æ ‡ ChatBot', 'error')
          return
        }

        const testActions = [
          {
            type: 'input',
            target: '#testInput',
            payload: { value: `æ¥è‡ªæµ‹è¯•ä»ªè¡¨æ¿çš„æ•°æ® - ${new Date().toLocaleTimeString()}` },
          },
          {
            type: 'click',
            target: '#testButton',
          },
          {
            type: 'custom',
            payload: {
              message: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯• Action',
              source: 'test-dashboard',
              timestamp: Date.now(),
            },
          },
        ]

        const randomAction = testActions[Math.floor(Math.random() * testActions.length)]

        log(`âš¡ å‘é€æµ‹è¯• Action åˆ° ${selectedTargetChatbotId}: ${randomAction.type}`, 'info')
        const result = await apiRequest(`${SERVER_URL}/api/action/${selectedTargetChatbotId}`, {
          method: 'POST',
          body: JSON.stringify(randomAction),
        })

        if (result.success) {
          log(`âœ… æµ‹è¯• Action å‘é€æˆåŠŸ: ${result.data.data.sent ? 'å·²é€è¾¾' : 'å·²æ’é˜Ÿ'}`, 'success')
          showResponse('chatbotResponse', result.data)
        } else {
          log(`âŒ æµ‹è¯• Action å‘é€å¤±è´¥: ${result.error}`, 'error')
        }
      }

      // è·å–é¡µé¢çŠ¶æ€æ“ä½œçš„ç›®æ ‡ ChatBot ID
      function getPageStateTargetId() {
        const selectedId = document.getElementById('pageStateChatbotSelect').value
        return selectedId || CHATBOT_ID
      }

      // é¡µé¢çŠ¶æ€ç®¡ç†
      async function updatePageState() {
        const targetId = getPageStateTargetId()
        const url = document.getElementById('pageUrl').value
        const title = document.getElementById('pageTitle').value
        const customDataText = document.getElementById('customData').value

        let customData = {}
        try {
          customData = JSON.parse(customDataText)
        } catch (e) {
          log('âŒ è‡ªå®šä¹‰æ•°æ® JSON æ ¼å¼é”™è¯¯', 'error')
          return
        }

        const state = {
          url,
          title,
          customData,
          viewport: {
            width: window.innerWidth,
            height: window.innerHeight,
          },
          timestamp: new Date().toISOString(),
        }

        log(`ğŸ’¾ æ›´æ–°é¡µé¢çŠ¶æ€åˆ° ${targetId}...`, 'info')
        const result = await apiRequest(`${SERVER_URL}/api/state/${targetId}`, {
          method: 'POST',
          body: JSON.stringify(state),
        })

        if (result.success) {
          log('âœ… é¡µé¢çŠ¶æ€æ›´æ–°æˆåŠŸ', 'success')
          showResponse('pageStateResponse', result.data)
        } else {
          log(`âŒ é¡µé¢çŠ¶æ€æ›´æ–°å¤±è´¥: ${result.error}`, 'error')
        }
      }

      async function getPageState() {
        const targetId = getPageStateTargetId()
        log(`ğŸ“– è·å–é¡µé¢çŠ¶æ€ä» ${targetId}...`, 'info')
        const result = await apiRequest(`${SERVER_URL}/api/state/${targetId}`)

        if (result.success) {
          if (result.data.data) {
            log('âœ… é¡µé¢çŠ¶æ€è·å–æˆåŠŸ', 'success')
            showResponse('pageStateResponse', result.data)
          } else {
            log('â„¹ï¸ æš‚æ— é¡µé¢çŠ¶æ€æ•°æ®', 'warning')
          }
        } else {
          log(`âŒ è·å–é¡µé¢çŠ¶æ€å¤±è´¥: ${result.error}`, 'error')
        }
      }

      async function deletePageState() {
        const targetId = getPageStateTargetId()
        log(`ğŸ—‘ï¸ åˆ é™¤é¡µé¢çŠ¶æ€ä» ${targetId}...`, 'info')
        const result = await apiRequest(`${SERVER_URL}/api/state/${targetId}`, {
          method: 'DELETE',
        })

        if (result.success) {
          log('âœ… é¡µé¢çŠ¶æ€åˆ é™¤æˆåŠŸ', 'success')
          showResponse('pageStateResponse', result.data)
        } else {
          log(`âŒ åˆ é™¤é¡µé¢çŠ¶æ€å¤±è´¥: ${result.error}`, 'error')
        }
      }

      // åŠ è½½ç›®æ ‡çš„é¡µé¢çŠ¶æ€åˆ°è¡¨å•ä¸­
      async function loadTargetPageState() {
        const targetId = getPageStateTargetId()
        if (targetId === CHATBOT_ID) {
          log('â„¹ï¸ å½“å‰ä½¿ç”¨çš„æ˜¯ä»ªè¡¨æ¿è‡ªèº«ï¼Œæ— éœ€åŠ è½½', 'warning')
          return
        }

        log(`ğŸ“¥ åŠ è½½ç›®æ ‡é¡µé¢çŠ¶æ€ä» ${targetId}...`, 'info')
        const result = await apiRequest(`${SERVER_URL}/api/state/${targetId}`)

        if (result.success && result.data.data) {
          const state = result.data.data

          // å¡«å……è¡¨å•æ•°æ®
          if (state.url) document.getElementById('pageUrl').value = state.url
          if (state.title) document.getElementById('pageTitle').value = state.title
          if (state.customData) {
            document.getElementById('customData').value = JSON.stringify(state.customData, null, 2)
          }

          log('âœ… ç›®æ ‡é¡µé¢çŠ¶æ€å·²åŠ è½½åˆ°è¡¨å•', 'success')
          showResponse('pageStateResponse', result.data)
        } else {
          log(`âŒ åŠ è½½ç›®æ ‡é¡µé¢çŠ¶æ€å¤±è´¥: ${result.error || 'æ— æ•°æ®'}`, 'error')
        }
      }

      // è·å– Action æ“ä½œçš„ç›®æ ‡ ChatBot ID
      function getActionTargetId() {
        const selectedId = document.getElementById('actionChatbotSelect').value
        return selectedId || selectedTargetChatbotId || CHATBOT_ID
      }

      // Action æ¨é€åŠŸèƒ½
      async function sendCustomAction() {
        const targetId = getActionTargetId()
        const type = document.getElementById('actionType').value
        const target = document.getElementById('actionTarget').value
        const payloadText = document.getElementById('actionPayload').value

        let payload = {}
        try {
          payload = JSON.parse(payloadText)
        } catch (e) {
          log('âŒ Action æ•°æ® JSON æ ¼å¼é”™è¯¯', 'error')
          return
        }

        const action = {
          type,
          target: target || undefined,
          payload: Object.keys(payload).length > 0 ? payload : undefined,
        }

        log(`ğŸš€ å‘é€ ${type} Action åˆ° ${targetId}...`, 'info')
        const result = await apiRequest(`${SERVER_URL}/api/action/${targetId}`, {
          method: 'POST',
          body: JSON.stringify(action),
        })

        if (result.success) {
          log(`âœ… Action å‘é€æˆåŠŸ: ${result.data.data.sent ? 'å·²é€è¾¾' : 'å·²æ’é˜Ÿ'}`, 'success')
          showResponse('actionResponse', result.data)
        } else {
          log(`âŒ Action å‘é€å¤±è´¥: ${result.error}`, 'error')
        }
      }

      async function sendQuickActions() {
        const actions = [
          { type: 'navigate', payload: { url: 'https://www.google.com' } },
          { type: 'click', target: '#search-button' },
          { type: 'input', target: '#search-input', payload: { value: 'æµ‹è¯•æœç´¢' } },
          { type: 'scroll', payload: { x: 0, y: 100 } },
        ]

        const targetId = getActionTargetId()
        log(`âš¡ å‘é€å¿«é€Ÿæµ‹è¯• Actions åˆ° ${targetId}...`, 'info')

        for (let i = 0; i < actions.length; i++) {
          const action = actions[i]
          const result = await apiRequest(`${SERVER_URL}/api/action/${targetId}`, {
            method: 'POST',
            body: JSON.stringify(action),
          })

          if (result.success) {
            log(`âœ… Action ${i + 1}/${actions.length} (${action.type}) å‘é€æˆåŠŸ`, 'success')
          } else {
            log(
              `âŒ Action ${i + 1}/${actions.length} (${action.type}) å‘é€å¤±è´¥: ${result.error}`,
              'error'
            )
          }

          // é—´éš”å‘é€
          if (i < actions.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 500))
          }
        }
      }

      async function broadcastAction() {
        const type = document.getElementById('actionType').value
        const target = document.getElementById('actionTarget').value
        const payloadText = document.getElementById('actionPayload').value

        let payload = {}
        try {
          payload = JSON.parse(payloadText)
        } catch (e) {
          log('âŒ Action æ•°æ® JSON æ ¼å¼é”™è¯¯', 'error')
          return
        }

        const action = {
          type,
          target: target || undefined,
          payload: Object.keys(payload).length > 0 ? payload : undefined,
        }

        log('ğŸ“¢ å¹¿æ’­ Action åˆ°æ‰€æœ‰è¿æ¥...', 'info')
        const result = await apiRequest(`${SERVER_URL}/api/action/broadcast`, {
          method: 'POST',
          body: JSON.stringify(action),
        })

        if (result.success) {
          log('âœ… Action å¹¿æ’­æˆåŠŸ', 'success')
          showResponse('actionResponse', result.data)
        } else {
          log(`âŒ Action å¹¿æ’­å¤±è´¥: ${result.error}`, 'error')
        }
      }

      // ç®¡ç†åŠŸèƒ½
      async function adminBroadcast() {
        const message = document.getElementById('broadcastMessage').value
        if (!message.trim()) {
          log('âŒ è¯·è¾“å…¥å¹¿æ’­æ¶ˆæ¯', 'error')
          return
        }

        log('ğŸ“¢ å‘é€ç®¡ç†å¹¿æ’­...', 'info')
        const result = await apiRequest(`${SERVER_URL}/admin/broadcast`, {
          method: 'POST',
          body: JSON.stringify({ message, type: 'admin' }),
        })

        if (result.success) {
          log('âœ… ç®¡ç†å¹¿æ’­å‘é€æˆåŠŸ', 'success')
          showResponse('adminResponse', result.data)
        } else {
          log(`âŒ ç®¡ç†å¹¿æ’­å¤±è´¥: ${result.error}`, 'error')
        }
      }

      async function adminCleanup() {
        log('ğŸ§¹ æ‰§è¡Œè¿æ¥æ¸…ç†...', 'info')
        const result = await apiRequest(`${SERVER_URL}/admin/cleanup`, {
          method: 'POST',
        })

        if (result.success) {
          log(`âœ… è¿æ¥æ¸…ç†å®Œæˆï¼Œæ¸…ç†äº† ${result.data.data.cleaned} ä¸ªè¿æ¥`, 'success')
          showResponse('adminResponse', result.data)
        } else {
          log(`âŒ è¿æ¥æ¸…ç†å¤±è´¥: ${result.error}`, 'error')
        }
      }

      async function disconnectOthers() {
        log('âŒ æ–­å¼€å…¶ä»–è¿æ¥...', 'info')
        // è¿™é‡Œå¯ä»¥å®ç°æ–­å¼€å…¶ä»–è¿æ¥çš„é€»è¾‘
        // ç”±äºå½“å‰ API ä¸æ”¯æŒæ‰¹é‡æ–­å¼€ï¼Œè¿™é‡Œåªæ˜¯ç¤ºä¾‹
        log('â„¹ï¸ æ­¤åŠŸèƒ½éœ€è¦æ‰©å±• API æ”¯æŒ', 'warning')
      }

      // å·¥å…·å‡½æ•°
      function generateNewChatbotId() {
        CHATBOT_ID = 'dashboard_' + Date.now()
        document.getElementById('chatbotIdDisplay').value = CHATBOT_ID
        log(`ğŸ”„ ç”Ÿæˆæ–°çš„ ChatBot ID: ${CHATBOT_ID}`, 'info')

        // å¦‚æœå½“å‰æœ‰è¿æ¥ï¼Œé‡æ–°è¿æ¥
        if (eventSource) {
          disconnect()
          setTimeout(connect, 1000)
        }
      }

      function exportLogs() {
        const logs = document.getElementById('logContainer').innerText
        const blob = new Blob([logs], { type: 'text/plain' })
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = `edge-sync-logs-${new Date().toISOString().slice(0, 19)}.txt`
        a.click()
        URL.revokeObjectURL(url)
        log('ğŸ“¥ æ—¥å¿—å·²å¯¼å‡º', 'success')
      }

      function importTestData() {
        // å¯¼å…¥ä¸€äº›æµ‹è¯•æ•°æ®
        document.getElementById('pageUrl').value = 'https://test.example.com/dashboard'
        document.getElementById('pageTitle').value = 'æµ‹è¯•ä»ªè¡¨æ¿é¡µé¢'
        document.getElementById('customData').value = JSON.stringify(
          {
            user: 'æµ‹è¯•ç”¨æˆ·',
            role: 'admin',
            features: ['dashboard', 'monitoring', 'actions'],
            timestamp: new Date().toISOString(),
            testData: true,
          },
          null,
          2
        )

        document.getElementById('actionTarget').value = '#test-element'
        document.getElementById('actionPayload').value = JSON.stringify(
          {
            url: 'https://test.example.com',
            value: 'æµ‹è¯•è¾“å…¥å€¼',
            coordinates: { x: 100, y: 200 },
          },
          null,
          2
        )

        log('ğŸ“¤ æµ‹è¯•æ•°æ®å·²å¯¼å…¥', 'success')
      }

      function showResponse(elementId, data) {
        const element = document.getElementById(elementId)
        element.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`
        element.style.display = 'block'

        // 3ç§’åè‡ªåŠ¨éšè—
        setTimeout(() => {
          element.style.display = 'none'
        }, 3000)
      }

      function formatBytes(bytes) {
        if (bytes === 0) return '0 B'
        const k = 1024
        const sizes = ['B', 'KB', 'MB', 'GB']
        const i = Math.floor(Math.log(bytes) / Math.log(k))
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
      }
    </script>
  </body>
</html>
